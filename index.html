import React, { useState, useEffect, useRef } from 'react';
import * as THREE from 'three';

const CyberpunkMarketplace = () => {
  const [activeTab, setActiveTab] = useState('intel');
  const [audioPlaying, setAudioPlaying] = useState(false);
  const mountRef = useRef(null);
  const audioRef = useRef(null);
  const analyserRef = useRef(null);
  const dataArrayRef = useRef(null);

  const tabs = [
    { id: 'intel', label: 'INTEL', katakana: 'インテル' },
    { id: 'software', label: 'SOFTWARE', katakana: 'ソフト' },
    { id: 'hardware', label: 'HARDWARE', katakana: 'ハード' },
    { id: 'ice', label: 'BLACK ICE', katakana: 'アイス' }
  ];

  const products = {
    intel: [
      { name: 'Corporate Database Access', price: '¥45,000', heat: 'HIGH', quality: '★★★★☆' },
      { name: 'Government Surveillance Feeds', price: '¥89,000', heat: 'EXTREME', quality: '★★★★★' },
      { name: 'Social Media Scrape Package', price: '¥12,000', heat: 'LOW', quality: '★★★☆☆' },
      { name: 'Financial Records Bundle', price: '¥67,000', heat: 'HIGH', quality: '★★★★☆' },
      { name: 'Medical Database Dump', price: '¥34,000', heat: 'MEDIUM', quality: '★★★☆☆' },
    ],
    software: [
      { name: 'Neural Backdoor Suite', price: '¥156,000', heat: 'EXTREME', quality: '★★★★★' },
      { name: 'Encryption Cracker Pro', price: '¥78,000', heat: 'HIGH', quality: '★★★★☆' },
      { name: 'Stealth VPN Matrix', price: '¥23,000', heat: 'LOW', quality: '★★★☆☆' },
      { name: 'AI Deepfake Generator', price: '¥45,000', heat: 'MEDIUM', quality: '★★★★☆' },
      { name: 'Quantum Decryptor', price: '¥234,000', heat: 'EXTREME', quality: '★★★★★' },
    ],
    hardware: [
      { name: 'Neural Interface Implant', price: '¥890,000', heat: 'MEDIUM', quality: '★★★★★' },
      { name: 'Scrambler Chip Set', price: '¥67,000', heat: 'LOW', quality: '★★★★☆' },
      { name: 'Biometric Spoofer', price: '¥123,000', heat: 'HIGH', quality: '★★★★☆' },
      { name: 'EMP Pulse Device', price: '¥345,000', heat: 'EXTREME', quality: '★★★★★' },
      { name: 'Drone Swarm Controller', price: '¥567,000', heat: 'HIGH', quality: '★★★★☆' },
    ],
    ice: [
      { name: 'Viral Countermeasure ICE', price: '¥234,000', heat: 'MEDIUM', quality: '★★★★★' },
      { name: 'Neural Firewall Deluxe', price: '¥145,000', heat: 'LOW', quality: '★★★★☆' },
      { name: 'Trace Killer Protocol', price: '¥89,000', heat: 'MEDIUM', quality: '★★★☆☆' },
      { name: 'Black Mirror Defense', price: '¥456,000', heat: 'HIGH', quality: '★★★★★' },
      { name: 'Ghost Protocol Suite', price: '¥678,000', heat: 'EXTREME', quality: '★★★★★' },
    ]
  };

  const tickerItems = [
    'BTC: ¥8,234,567',
    'ETH: ¥567,890',
    'CORP-DATA +15%',
    'GOV-INTEL -8%',
    'NEURAL-WARE +23%',
    'ICE-BREACH ALERT',
    'MARKET VOLATILITY: HIGH',
    'NEURAL LINK: ACTIVE'
  ];

  useEffect(() => {
    if (!mountRef.current) return;

    const scene = new THREE.Scene();
    scene.fog = new THREE.Fog(0x000000, 10, 50);
    
    const camera = new THREE.PerspectiveCamera(75, mountRef.current.clientWidth / mountRef.current.clientHeight, 0.1, 1000);
    camera.position.z = 15;
    camera.position.y = 5;

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(mountRef.current.clientWidth, mountRef.current.clientHeight);
    renderer.setClearColor(0x000000, 0.3);
    mountRef.current.appendChild(renderer.domElement);

    const buildings = new THREE.Group();
    
    for (let i = 0; i < 30; i++) {
      const height = Math.random() * 10 + 3;
      const geometry = new THREE.BoxGeometry(1, height, 1);
      const edges = new THREE.EdgesGeometry(geometry);
      const material = new THREE.LineBasicMaterial({ 
        color: Math.random() > 0.5 ? 0x00ffff : 0xff00ff,
        transparent: true,
        opacity: 0.6
      });
      const building = new THREE.LineSegments(edges, material);
      
      const angle = (i / 30) * Math.PI * 2;
      const radius = 8 + Math.random() * 5;
      building.position.x = Math.cos(angle) * radius;
      building.position.z = Math.sin(angle) * radius;
      building.position.y = height / 2;
      
      buildings.add(building);
    }
    
    scene.add(buildings);

    const gridHelper = new THREE.GridHelper(50, 50, 0x00ffff, 0xff00ff);
    gridHelper.position.y = 0;
    gridHelper.material.opacity = 0.2;
    gridHelper.material.transparent = true;
    scene.add(gridHelper);

    const animate = () => {
      requestAnimationFrame(animate);
      buildings.rotation.y += 0.002;
      
      if (analyserRef.current && dataArrayRef.current) {
        analyserRef.current.getByteFrequencyData(dataArrayRef.current);
        const bass = dataArrayRef.current[0] / 255;
        gridHelper.material.opacity = 0.2 + bass * 0.3;
      }
      
      renderer.render(scene, camera);
    };

    animate();

    const handleResize = () => {
      if (!mountRef.current) return;
      camera.aspect = mountRef.current.clientWidth / mountRef.current.clientHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(mountRef.current.clientWidth, mountRef.current.clientHeight);
    };

    window.addEventListener('resize', handleResize);

    return () => {
      window.removeEventListener('resize', handleResize);
      if (mountRef.current) {
        mountRef.current.removeChild(renderer.domElement);
      }
    };
  }, []);

  const toggleAudio = () => {
    if (!audioRef.current) {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      analyserRef.current = audioContext.createAnalyser();
      dataArrayRef.current = new Uint8Array(analyserRef.current.frequencyBinCount);
      
      oscillator.type = 'sawtooth';
      oscillator.frequency.setValueAtTime(110, audioContext.currentTime);
      gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
      
      oscillator.connect(gainNode);
      gainNode.connect(analyserRef.current);
      analyserRef.current.connect(audioContext.destination);
      
      oscillator.start();
      audioRef.current = { oscillator, gainNode, audioContext };
      setAudioPlaying(true);
    } else {
      audioRef.current.oscillator.stop();
      audioRef.current.audioContext.close();
      audioRef.current = null;
      setAudioPlaying(false);
    }
  };

  return (
    <div className="relative w-full h-screen bg-black overflow-hidden font-mono">
      <style>{`
        @keyframes scanline {
          0% { transform: translateY(-100%); }
          100% { transform: translateY(100vh); }
        }
        @keyframes marquee {
          0% { transform: translateX(100%); }
          100% { transform: translateX(-100%); }
        }
        @keyframes glitch {
          0%, 100% { transform: translate(0); }
          25% { transform: translate(-2px, 2px); }
          50% { transform: translate(2px, -2px); }
          75% { transform: translate(-2px, -2px); }
        }
        @keyframes pulse {
          0%, 100% { opacity: 0.3; }
          50% { opacity: 1; }
        }
        @keyframes shimmer {
          0% { background-position: -100% 0; }
          100% { background-position: 200% 0; }
        }
        @keyframes circuit {
          0% { stroke-dashoffset: 100; }
          100% { stroke-dashoffset: 0; }
        }
        .scanline::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 2px;
          background: rgba(0, 255, 255, 0.1);
          animation: scanline 6s linear infinite;
          pointer-events: none;
        }
        .crt-curve {
          border-radius: 3% / 5%;
        }
        .holographic {
          background: linear-gradient(90deg, 
            transparent 0%, 
            rgba(0, 255, 255, 0.2) 25%, 
            rgba(255, 0, 255, 0.2) 50%, 
            rgba(0, 255, 255, 0.2) 75%, 
            transparent 100%);
          background-size: 200% 100%;
          animation: shimmer 3s linear infinite;
        }
        .circuit-trace {
          position: relative;
          overflow: hidden;
        }
        .circuit-trace::after {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: 
            linear-gradient(90deg, transparent 48%, #0ff 49%, #0ff 51%, transparent 52%),
            linear-gradient(0deg, transparent 48%, #f0f 49%, #f0f 51%, transparent 52%);
          opacity: 0;
          transition: opacity 0.3s;
          pointer-events: none;
        }
        .circuit-trace:hover::after {
          opacity: 0.3;
        }
      `}</style>

      <div ref={mountRef} className="absolute inset-0 opacity-30" />

      <div className="absolute top-0 left-0 w-full h-12 bg-gradient-to-b from-black to-transparent overflow-hidden border-b-2 border-cyan-500">
        <div className="flex items-center h-full whitespace-nowrap text-cyan-400 text-sm">
          <div className="inline-block animate-[marquee_20s_linear_infinite]">
            {tickerItems.map((item, i) => (
              <span key={i} className="mx-8 animate-pulse">
                ▸ {item}
              </span>
            ))}
            {tickerItems.map((item, i) => (
              <span key={`dup-${i}`} className="mx-8 animate-pulse">
                ▸ {item}
              </span>
            ))}
          </div>
        </div>
      </div>

      <div className="relative z-10 p-8 pt-20 h-full">
        <div className="max-w-6xl mx-auto">
          <div className="text-center mb-8">
            <h1 className="text-5xl font-bold mb-2 text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 via-purple-500 to-pink-500 animate-[glitch_2s_infinite]">
              ≡ DARKNET BAZAAR ≡
            </h1>
            <p className="text-cyan-400 text-sm tracking-widest">
              █▓▒░ UNAUTHORIZED ACCESS DETECTED ░▒▓█
            </p>
          </div>

          <div className="flex gap-2 mb-6 justify-center">
            {tabs.map(tab => (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id)}
                className={`circuit-trace px-6 py-3 border-2 transition-all crt-curve relative overflow-hidden ${
                  activeTab === tab.id
                    ? 'border-cyan-400 bg-cyan-400 bg-opacity-20 text-cyan-300 shadow-[0_0_20px_rgba(0,255,255,0.5)]'
                    : 'border-purple-500 bg-purple-900 bg-opacity-20 text-purple-400 hover:border-cyan-400 hover:shadow-[0_0_10px_rgba(0,255,255,0.3)]'
                }`}
              >
                <div className="holographic absolute inset-0 opacity-30" />
                <div className="relative z-10">
                  <div className="text-xs mb-1 font-bold">{tab.label}</div>
                  <div className="text-[10px] opacity-70">{tab.katakana}</div>
                </div>
              </button>
            ))}
          </div>

          <div className="scanline relative bg-black bg-opacity-80 border-4 border-cyan-500 crt-curve p-6 shadow-[0_0_30px_rgba(0,255,255,0.3)] min-h-[400px]">
            <div className="absolute top-0 left-0 w-full h-full pointer-events-none">
              <div className="absolute inset-0 bg-gradient-to-b from-transparent via-cyan-500 to-transparent opacity-5 animate-[pulse_3s_ease-in-out_infinite]" />
            </div>

            <div className="relative z-10 h-[350px] overflow-y-auto pr-2 scrollbar-thin scrollbar-thumb-cyan-500 scrollbar-track-transparent">
              {products[activeTab].map((product, i) => (
                <div
                  key={i}
                  className="circuit-trace border-l-4 border-purple-500 bg-gradient-to-r from-black to-purple-900 bg-opacity-40 p-4 mb-3 hover:border-cyan-400 hover:shadow-[0_0_15px_rgba(0,255,255,0.3)] transition-all cursor-pointer crt-curve"
                >
                  <div className="flex justify-between items-start">
                    <div>
                      <div className="text-cyan-300 font-bold text-lg mb-1">
                        {product.name}
                      </div>
                      <div className="text-purple-400 text-xs flex gap-3">
                        <span>HEAT: <span className={`font-bold ${
                          product.heat === 'EXTREME' ? 'text-red-500' :
                          product.heat === 'HIGH' ? 'text-orange-500' :
                          product.heat === 'MEDIUM' ? 'text-yellow-500' :
                          'text-green-500'
                        }`}>{product.heat}</span></span>
                        <span className="text-yellow-400">{product.quality}</span>
                      </div>
                    </div>
                    <div className="text-right">
                      <div className="text-green-400 font-bold text-xl">
                        {product.price}
                      </div>
                      <div className="text-[10px] text-gray-500 mt-1">
                        [ENCRYPTED]
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>

          <div className="mt-6 flex justify-center gap-4">
            <button
              onClick={toggleAudio}
              className="circuit-trace px-6 py-2 border-2 border-pink-500 bg-pink-900 bg-opacity-20 text-pink-400 hover:border-pink-300 hover:shadow-[0_0_15px_rgba(255,0,255,0.5)] transition-all crt-curve"
            >
              {audioPlaying ? '◼ STOP RADIO' : '▶ CYBERPUNK RADIO'}
            </button>
            <button className="circuit-trace px-6 py-2 border-2 border-green-500 bg-green-900 bg-opacity-20 text-green-400 hover:border-green-300 hover:shadow-[0_0_15px_rgba(0,255,0,0.5)] transition-all crt-curve">
              ⚡ QUICK BUY
            </button>
            <button className="circuit-trace px-6 py-2 border-2 border-yellow-500 bg-yellow-900 bg-opacity-20 text-yellow-400 hover:border-yellow-300 hover:shadow-[0_0_15px_rgba(255,255,0,0.5)] transition-all crt-curve">
              ◎ CRYPTO WALLET
            </button>
          </div>
        </div>
      </div>

      <div className="absolute bottom-0 left-0 w-full h-24 bg-gradient-to-t from-black to-transparent flex items-center justify-center text-cyan-400 text-xs opacity-50">
        <div className="animate-pulse">
          CONNECTION: ANONYMOUS ◆ ENCRYPTION: AES-256 ◆ LOCATION: SCRAMBLED
        </div>
      </div>
    </div>
  );
};

export default CyberpunkMarketplace;
